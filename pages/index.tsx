import { useAtom } from "jotai";
import type { NextPage } from "next";
import Head from "next/head";
import Image from "next/image";
import { SyntheticEvent } from "react";
import Rules from "../components/onboarding/Rules";
import { useMutation, useQuery } from "../convex/_generated";
import { Team } from "../util/common";
import { claimedTeamAtom } from "../util/jotai";

const TeamCard: React.FC<{ team: Team }> = ({ team }) => {
  const claimTeam = useMutation("claimTeam");
  const [claimedTeam, setClaimedTeam] = useAtom(claimedTeamAtom);

  const handleClaim = (e: SyntheticEvent) => {
    e.preventDefault();
    console.log({ team });

    // Run claimTeam mutation
    claimTeam(team._id);
    // Save current team to global state and localStorage
    setClaimedTeam({ ...team, claimed: true });
  };

  return (
    <button
      disabled={team.claimed || !!claimedTeam}
      onClick={handleClaim}
      className="w-full border border-slate-200 rounded-xl p-4 px-6 flex justify-between items-center my-5 disabled:bg-slate-200 hover:bg-slate-100/50 transition"
    >
      <div className="flex-1 flex flex-col gap-y-1">
        <div className="text-left text-lg font-bold">
          Team {team.tnumber}{" "}
          {team.tnumber == claimedTeam?.tnumber ? "(you)" : ""}
        </div>
        <div className="text-left">{team.name}</div>
      </div>
      <div>
        <div
          className={`rounded-full h-[15px] w-[15px] ${
            team.claimed ? `bg-green-500` : `bg-red-500`
          }`}
        ></div>
      </div>
    </button>
  );
};

const Home: NextPage = () => {
  const teams = useQuery("allTeams") || [];

  return (
    <div>
      <Head>
        <title>ExQuiz</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <div className="h-screen w-screen grid grid-cols-2 p-[50px] gap-x-[50px] text-slate-700">
        <Rules />
        <div className="flex flex-col justify-center items-stretch gap-y-5">
          <h1 className="text-center text-slate-600 text-3xl font-bold">
            Choose a team
          </h1>
          <div className="max-w-[500px] w-full mx-auto">
            {teams.map((team, i) => (
              <TeamCard team={team} key={i} />
            ))}
          </div>
          <div className="text-center">The quiz will begin shortly</div>
        </div>
      </div>
    </div>
  );
};

export default Home;
